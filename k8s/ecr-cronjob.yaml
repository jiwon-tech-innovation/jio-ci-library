# 1. ë´‡ì—ê²Œ ì¤„ ì‹ ë¶„ì¦ (ServiceAccount)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ecr-refresh-sa
  namespace: cicd
---
# 2. ë´‡ì´ í•  ìˆ˜ ìˆëŠ” ì¼ (Role: ì‹œí¬ë¦¿ ì¡°íšŒ/ì‚­ì œ/ìƒì„±)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ecr-refresh-role
  namespace: cicd
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "delete", "create"]
---
# 3. ì‹ ë¶„ì¦ê³¼ ê¶Œí•œ ì—°ê²° (RoleBinding)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ecr-refresh-binding
  namespace: cicd
subjects:
  - kind: ServiceAccount
    name: ecr-refresh-sa
    namespace: cicd
roleRef:
  kind: Role
  name: ecr-refresh-role
  apiGroup: rbac.authorization.k8s.io
---
# 4. 10ì‹œê°„ë§ˆë‹¤ ì¼í•˜ëŠ” ì‘ì—…ë°˜ì¥ (CronJob)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecr-registry-helper
  namespace: cicd
spec:
  schedule: "0 */10 * * *" # 10ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ecr-refresh-sa
          containers:
          - name: ecr-refresher
            image: odaniait/aws-kubectl:latest
            imagePullPolicy: IfNotPresent
            env:
              - name: AWS_REGION
                value: "ap-northeast-2"
              - name: ECR_REGISTRY
                value: "541673202749.dkr.ecr.ap-northeast-2.amazonaws.com"
              # ì•„ê¹Œ ë§Œë“  aws-secretì—ì„œ í‚¤ë¥¼ êº¼ë‚´ì˜´ (ì•ˆì „!)
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: aws-secret
                    key: access-key
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: aws-secret
                    key: secret-key
            command:
              - /bin/sh
              - -c
              - |
                echo "ğŸš€ ECR í† í° ê°±ì‹  ì‹œì‘..."
                ECR_TOKEN=$(aws ecr get-login-password --region ${AWS_REGION})
                
                # ê¸°ì¡´ ì‹œí¬ë¦¿ ì‚­ì œ í›„ ì¬ìƒì„± (ë®ì–´ì“°ê¸°)
                kubectl delete secret ecr-credentials -n cicd --ignore-not-found
                
                kubectl create secret docker-registry ecr-credentials \
                  --docker-server=${ECR_REGISTRY} \
                  --docker-username=AWS \
                  --docker-password=${ECR_TOKEN} \
                  -n cicd
                  
                echo "âœ… ECR í† í° ê°±ì‹  ì™„ë£Œ!"
          restartPolicy: Never
